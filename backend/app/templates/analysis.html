{% extends "base.html" %}

{% block title %}Dataset Analysis - Data Analysis Platform{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 id="datasetName">Dataset Analysis</h2>
        <div>
            <a href="/" class="btn btn-outline-primary me-2">Back to Home</a>
            <div class="dropdown d-inline-block">
                <button class="btn btn-outline-success dropdown-toggle" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Download
                </button>
                <ul class="dropdown-menu" aria-labelledby="downloadDropdown">
                    <li><a id="downloadBtn" href="#" class="dropdown-item">Download Dataset (CSV)</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a id="downloadEDAReportBtn" href="#" class="dropdown-item">Download EDA Report (PDF)</a></li>
                </ul>
            </div>
            <div class="dropdown d-inline-block ms-2">
                <button class="btn btn-outline-info dropdown-toggle" type="button" id="actionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Actions
                </button>
                <ul class="dropdown-menu" aria-labelledby="actionsDropdown">
                    <li><a id="shareProjectBtn" href="#" class="dropdown-item">Share Project</a></li>
                    <li><a id="versionHistoryBtn" href="#" class="dropdown-item">Version History</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a id="anomalyDetectionBtn" href="#" class="dropdown-item">Anomaly Detection</a></li>
                    <li><a id="causalAnalysisBtn" href="#" class="dropdown-item">Causal Analysis</a></li>
                </ul>
            </div>
            <button class="btn btn-outline-secondary ms-2" id="helpGuideBtn">
                <i class="fas fa-question-circle"></i> Guided Workflow
            </button>
        </div>
    </div>
    
    <ul class="nav nav-tabs" id="analysisTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">Overview</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="eda-tab" data-bs-toggle="tab" data-bs-target="#eda" type="button" role="tab" aria-controls="eda" aria-selected="false">Exploratory Analysis</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="feature-engineering-tab" data-bs-toggle="tab" data-bs-target="#feature-engineering" type="button" role="tab" aria-controls="feature-engineering" aria-selected="false">Feature Engineering</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pca-tab" data-bs-toggle="tab" data-bs-target="#pca" type="button" role="tab" aria-controls="pca" aria-selected="false">Dimensionality Reduction</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab" aria-controls="advanced" aria-selected="false">Advanced Analytics</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="collaboration-tab" data-bs-toggle="tab" data-bs-target="#collaboration" type="button" role="tab" aria-controls="collaboration" aria-selected="false">Collaboration</button>
        </li>
    </ul>
    
    <div class="tab-content mt-3" id="analysisTabContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
            <div id="loadingSpinner" class="text-center my-4">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading dataset info...</span>
                </div>
                <p>Loading dataset information...</p>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Dataset Information</div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tbody id="datasetInfo">
                                    <!-- Dataset info will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Column Types</div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Column</th>
                                        <th>Type</th>
                                        <th>Missing</th>
                                    </tr>
                                </thead>
                                <tbody id="columnTypes">
                                    <!-- Column types will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">Numeric Summary</div>
                        <div class="card-body">
                            <div id="numericSummary">
                                <!-- Numeric summary will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- EDA Tab -->
        <div class="tab-pane fade" id="eda" role="tabpanel" aria-labelledby="eda-tab">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Exploratory Data Analysis</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" id="refreshEDABtn">Refresh Analysis</button>
                        <button class="btn btn-sm btn-outline-secondary" id="downloadEDABtn">Download Report</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="edaSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p>Generating exploratory analysis...</p>
                    </div>
                    <div id="edaError" class="alert alert-danger" style="display: none;"></div>
                    
                    <div id="edaContent">
                        <!-- EDA content will be populated here -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card mb-4">
                                    <div class="card-header">Correlation Matrix</div>
                                    <div class="card-body">
                                        <div id="correlationMatrix"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="card mb-4">
                                    <div class="card-header">Data Distribution</div>
                                    <div class="card-body">
                                        <div id="distributionPlots"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="card mb-4">
                                    <div class="card-header">Feature Relationships</div>
                                    <div class="card-body">
                                        <div id="featureRelationships"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="card mb-4">
                                    <div class="card-header">Missing Values</div>
                                    <div class="card-body">
                                        <div id="missingValues"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="card mb-4">
                                    <div class="card-header">Outlier Detection</div>
                                    <div class="card-body">
                                        <div id="outlierDetection"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Feature Engineering Tab -->
        <div class="tab-pane fade" id="feature-engineering" role="tabpanel" aria-labelledby="feature-engineering-tab">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">AI-Powered Feature Engineering Suggestions</div>
                        <div class="card-body">
                            <div id="suggestionsSpinner" class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                                <p>Generating suggestions...</p>
                            </div>
                            <div id="suggestionsError" class="alert alert-danger" style="display: none;"></div>
                            <div id="suggestionsList" style="display: none;">
                                <!-- Suggestions will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">Apply Selected Suggestions</div>
                        <div class="card-body">
                            <p>Select the feature engineering suggestions you want to apply to your dataset.</p>
                            
                            <button id="applyFeaturesBtn" class="btn btn-primary mt-3" disabled>
                                Apply Selected Features
                            </button>
                            
                            <div id="applySpinner" class="text-center mt-3" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                                <div class="mt-2 loading-text">Applying transformations...</div>
                            </div>
                            
                            <div id="applySuccess" class="alert alert-success mt-3" style="display: none;">
                                Transformations applied successfully! <a href="#" id="viewTransformedBtn">View transformed dataset</a>
                            </div>
                            
                            <div id="applyError" class="alert alert-danger mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add PCA tab content -->
        <div class="tab-pane fade" id="pca" role="tabpanel" aria-labelledby="pca-tab">
            <div class="card">
                <div class="card-header">Principal Component Analysis (PCA)</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">PCA Configuration</div>
                                <div class="card-body">
                                    <p>PCA reduces the dimensionality of your dataset while preserving as much variance as possible.</p>
                                    
                                    <div class="form-group">
                                        <label for="pcaComponents">Number of PCA Components:</label>
                                        <input type="number" class="form-control" id="pcaComponents" min="2" max="10" value="2">
                                        <small class="form-text text-muted">Choose between 2-10 components</small>
                                    </div>
                                    
                                    <div class="form-group mt-3">
                                        <label for="varianceThreshold">Variance Threshold:</label>
                                        <input type="range" class="form-range" id="varianceThreshold" min="0.5" max="0.99" step="0.01" value="0.8">
                                        <small class="form-text text-muted">Variance to preserve: <span id="varianceValue">0.8</span></small>
                                    </div>
                                    
                                    <button id="applyPCABtn" class="btn btn-primary mt-3">
                                        Apply PCA
                                    </button>
                                    
                                    <div id="pcaSpinner" class="text-center mt-3" style="display: none;">
                                        <div class="spinner-border" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                        <p>Applying PCA...</p>
                                    </div>
                                    
                                    <div id="pcaSuccess" class="alert alert-success mt-3" style="display: none;">
                                        PCA applied successfully! <a href="#" id="viewPCABtn">View transformed dataset</a>
                                    </div>
                                    
                                    <div id="pcaError" class="alert alert-danger mt-3" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">PCA Results</div>
                                <div class="card-body">
                                    <div id="pcaResults">
                                        <p>Apply PCA to see results here.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Advanced Analytics tab content -->
        <div class="tab-pane fade" id="advanced" role="tabpanel" aria-labelledby="advanced-tab">
            <div class="card">
                <div class="card-header">Advanced Analytics</div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5>Anomaly Detection</h5>
                                </div>
                                <div class="card-body">
                                    <p>Automatically identify outliers and unusual patterns in your dataset.</p>
                                    <div class="form-group mb-3">
                                        <label for="anomalyMethod">Detection Method:</label>
                                        <select class="form-control" id="anomalyMethod">
                                            <option value="isolation_forest">Isolation Forest</option>
                                            <option value="lof">Local Outlier Factor</option>
                                            <option value="dbscan">DBSCAN</option>
                                        </select>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="anomalyThreshold">Sensitivity Threshold:</label>
                                        <input type="range" class="form-range" id="anomalyThreshold" min="0.01" max="0.2" step="0.01" value="0.05">
                                        <small class="form-text text-muted">Threshold: <span id="anomalyThresholdValue">0.05</span></small>
                                    </div>
                                    <button id="detectAnomaliesBtn" class="btn btn-primary">Detect Anomalies</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5>Correlation Analysis</h5>
                                </div>
                                <div class="card-body">
                                    <p>Understand relationships between variables with natural language explanations.</p>
                                    <div class="form-group mb-3">
                                        <label for="correlationMethod">Analysis Method:</label>
                                        <select class="form-control" id="correlationMethod">
                                            <option value="pearson">Pearson (Linear)</option>
                                            <option value="spearman">Spearman (Monotonic)</option>
                                            <option value="kendall">Kendall (Ordinal)</option>
                                        </select>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="correlationThreshold">Minimum Correlation:</label>
                                        <input type="range" class="form-range" id="correlationThreshold" min="0.1" max="0.9" step="0.05" value="0.5">
                                        <small class="form-text text-muted">Threshold: <span id="correlationThresholdValue">0.5</span></small>
                                    </div>
                                    <button id="explainCorrelationsBtn" class="btn btn-primary">Explain Correlations</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5>Causal Inference</h5>
                                </div>
                                <div class="card-body">
                                    <p>Discover potential cause-effect relationships in your data.</p>
                                    <div class="form-group mb-3">
                                        <label for="causalTarget">Target Variable:</label>
                                        <select class="form-control" id="causalTarget">
                                            <option value="">Select a variable...</option>
                                        </select>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="causalMethod">Method:</label>
                                        <select class="form-control" id="causalMethod">
                                            <option value="correlation">Correlation-based</option>
                                            <option value="propensity">Propensity Matching</option>
                                            <option value="doWhy">DoWhy Framework</option>
                                        </select>
                                    </div>
                                    <button id="analyzeCausalBtn" class="btn btn-primary">Analyze Causality</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="advancedResultsContainer">
                        <div id="anomalyResults" style="display: none;">
                            <div class="card mb-4">
                                <div class="card-header">Anomaly Detection Results</div>
                                <div class="card-body">
                                    <div id="anomalyPlot"></div>
                                    <div id="anomalySummary" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="correlationResults" style="display: none;">
                            <div class="card mb-4">
                                <div class="card-header">Correlation Analysis with Explanations</div>
                                <div class="card-body">
                                    <div id="correlationExplanations"></div>
                                    <div id="correlationNetwork" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="causalResults" style="display: none;">
                            <!-- Causal analysis results will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Collaboration tab content -->
        <div class="tab-pane fade" id="collaboration" role="tabpanel" aria-labelledby="collaboration-tab">
            <div class="card">
                <div class="card-header">Collaboration Features</div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Project Sharing</h5>
                                </div>
                                <div class="card-body">
                                    <p>Share this dataset and analysis with team members.</p>
                                    <div class="form-group mb-3">
                                        <label for="shareEmail">Email Address:</label>
                                        <input type="email" class="form-control" id="shareEmail" placeholder="colleague@example.com">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="sharePermission">Permission Level:</label>
                                        <select class="form-control" id="sharePermission">
                                            <option value="view">View Only</option>
                                            <option value="edit">Edit</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                    <button id="shareBtn" class="btn btn-primary">Share Project</button>
                                    
                                    <hr>
                                    
                                    <h6 class="mt-3">Current Collaborators</h6>
                                    <div id="collaboratorsList" class="list-group mt-2">
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">You (Owner)</h6>
                                                <small>Admin</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Version History</h5>
                                </div>
                                <div class="card-body">
                                    <p>Track changes to your dataset and transformations.</p>
                                    <div id="versionHistoryList" class="list-group">
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">Initial Upload</h6>
                                                <small class="text-muted">Current Version</small>
                                            </div>
                                            <p class="mb-1">Original dataset upload</p>
                                            <small class="text-muted">Created just now</small>
                                        </div>
                                    </div>
                                    
                                    <hr>
                                    
                                    <h6 class="mt-3">Create Version Checkpoint</h6>
                                    <div class="form-group mb-3">
                                        <label for="versionName">Version Name:</label>
                                        <input type="text" class="form-control" id="versionName" placeholder="e.g., After Feature Engineering">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="versionNotes">Notes:</label>
                                        <textarea class="form-control" id="versionNotes" rows="2" placeholder="Describe the changes in this version"></textarea>
                                    </div>
                                    <button id="createVersionBtn" class="btn btn-primary">Create Checkpoint</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>Annotations & Comments</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div id="commentsContainer" class="mb-3">
                                        <div class="card mb-2">
                                            <div class="card-body">
                                                <h6 class="card-subtitle mb-2 text-muted">You, just now</h6>
                                                <p class="card-text">Initial analysis started.</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="newComment">Add Comment:</label>
                                        <textarea class="form-control" id="newComment" rows="2" placeholder="Add your observations or questions here..."></textarea>
                                    </div>
                                    <button id="addCommentBtn" class="btn btn-primary mt-2">Add Comment</button>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">Data Annotations</div>
                                        <div class="card-body">
                                            <p>Add notes to specific data points or visualizations.</p>
                                            <button id="addAnnotationBtn" class="btn btn-outline-primary">Add Annotation</button>
                                            
                                            <div id="annotationsList" class="list-group mt-3">
                                                <div class="list-group-item">
                                                    <small class="text-muted">No annotations yet</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Get dataset ID from URL - support both query param and path param
    const urlParams = new URLSearchParams(window.location.search);
    let datasetId = urlParams.get('id');
    
    // If not found in query params, try to get from path
    if (!datasetId) {
        const pathParts = window.location.pathname.split('/');
        if (pathParts.length > 2) {
            datasetId = pathParts[pathParts.length - 1];
        }
    }
    
    // Add this helper function after the datasetId definition
    // Helper function to get the correct API endpoint URL
    function getApiUrl(endpoint, includeDatasetPrefix = true) {
        // Check if the endpoint already starts with a slash
        const formattedEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
        
        // For the new advanced analytics endpoints that don't use the /dataset/ prefix
        const advancedEndpoints = ['/anomalies', '/correlation-explanation', '/causal-analysis'];
        const needsDatasetPrefix = includeDatasetPrefix && !advancedEndpoints.some(e => formattedEndpoint.includes(e));
        
        // Construct the URL with or without the /dataset/ prefix
        return `/api/v1${needsDatasetPrefix ? '/dataset' : ''}/${datasetId}${formattedEndpoint}`;
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        if (!datasetId) {
            alert('No dataset ID provided');
            window.location.href = '/';
            return;
        }
        
        // Validate dataset ID format (should be a 24-character hex string)
        if (!/^[0-9a-f]{24}$/i.test(datasetId)) {
            alert('Invalid dataset ID format');
            window.location.href = '/';
            return;
        }
        
        console.log("Working with dataset ID:", datasetId);
        
        // Set up download buttons
        document.getElementById('downloadBtn').href = getApiUrl('/download');
        document.getElementById('downloadEDAReportBtn').href = getApiUrl('/eda-report');
        
        // Load dataset information
        loadDatasetInfo();
        
        // Set up tab change events
        const tabs = document.querySelectorAll('button[data-bs-toggle="tab"]');
        tabs.forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(event) {
                const targetId = event.target.getAttribute('data-bs-target');
                if (targetId === '#eda') {
                    loadEDA();
                } else if (targetId === '#feature-engineering') {
                    loadFeatureSuggestions();
                }
            });
        });
        
        // Set up apply features button
        document.getElementById('applyFeaturesBtn').addEventListener('click', applyFeatureSuggestions);

        // Add event listener for variance threshold slider
        document.getElementById('varianceThreshold').addEventListener('input', function() {
            document.getElementById('varianceValue').textContent = this.value;
        });

        // Add event listener for apply PCA button
        document.getElementById('applyPCABtn').addEventListener('click', applyPCA);
        
        // Add event listeners for refresh EDA and download EDA report buttons
        document.getElementById('refreshEDABtn').addEventListener('click', function() {
            // Clear existing content to force reload
            document.getElementById('correlationMatrix').innerHTML = '';
            document.getElementById('distributionPlots').innerHTML = '';
            document.getElementById('featureRelationships').innerHTML = '';
            document.getElementById('missingValues').innerHTML = '';
            document.getElementById('outlierDetection').innerHTML = '';
            loadEDA();
        });

        document.getElementById('downloadEDABtn').addEventListener('click', function() {
            window.open(getApiUrl("/eda-report"), "_blank");
        });
        
        // Add event listener for the new download EDA report button in the dropdown
        document.getElementById('downloadEDAReportBtn').addEventListener('click', function(e) {
            e.preventDefault();
            window.open(getApiUrl("/eda-report"), "_blank");
        });
        
        // Add event delegation for viewTransformedBtn clicks
        document.addEventListener('click', function(event) {
            if (event.target && (event.target.id === 'viewTransformedBtn' || event.target.closest('#viewTransformedBtn'))) {
                event.preventDefault();
                const href = event.target.href || event.target.closest('#viewTransformedBtn').href;
                if (href) {
                    const newDatasetId = href.split('/').pop();
                    if (newDatasetId && /^[0-9a-f]{24}$/i.test(newDatasetId)) {
                        // Update the dataset ID
                        datasetId = newDatasetId;
                        
                        // Update the URL without reloading the page
                        window.history.pushState({}, '', `/analysis/${datasetId}`);
                        
                        // Update the download buttons
                        document.getElementById('downloadBtn').href = getApiUrl('/download');
                        document.getElementById('downloadEDAReportBtn').href = getApiUrl('/eda-report');
                        
                        // Clear existing content to force reload
                        document.getElementById('correlationMatrix').innerHTML = '';
                        document.getElementById('distributionPlots').innerHTML = '';
                        document.getElementById('featureRelationships').innerHTML = '';
                        document.getElementById('missingValues').innerHTML = '';
                        document.getElementById('outlierDetection').innerHTML = '';
                        
                        // Load dataset info
                        loadDatasetInfo();
                        
                        // Switch to the EDA tab and load it
                        const edaTab = document.getElementById('eda-tab');
                        if (edaTab) {
                            edaTab.click();
                        }
                    }
                }
            }
        });
    });
    
    // Load dataset information
    async function loadDatasetInfo() {
        try {
            toggleSpinner('loadingSpinner', true);
            
            // Use fetch directly with error handling
            const response = await fetch(getApiUrl(''));
            if (!response.ok) {
                throw new Error(`Failed to load dataset: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            toggleSpinner('loadingSpinner', false);
            
            // Check if data is valid
            if (!data) {
                throw new Error("No data returned from the server");
            }
            
            // Set dataset name
            document.getElementById('datasetName').textContent = data.name || "Unnamed Dataset";
            
            // Populate dataset info
            const infoTable = document.getElementById('datasetInfo');
            infoTable.innerHTML = `
                <tr><td>Name</td><td>${data.name || "Unnamed Dataset"}</td></tr>
                <tr><td>Original Filename</td><td>${data.original_filename || data.name || "Unknown"}</td></tr>
                <tr><td>Upload Time</td><td>${data.upload_time ? new Date(data.upload_time).toLocaleString() : "Unknown"}</td></tr>
                <tr><td>Row Count</td><td>${data.row_count || "Unknown"}</td></tr>
                <tr><td>Column Count</td><td>${data.columns ? data.columns.length : "Unknown"}</td></tr>
            `;
            
            // Populate column types
            const columnTypesTable = document.getElementById('columnTypes');
            columnTypesTable.innerHTML = '';
            
            if (data.columns && data.metadata && data.metadata.dtypes) {
                data.columns.forEach(column => {
                    const dtype = data.metadata.dtypes[column] || "Unknown";
                    const missing = data.metadata.missing_values && data.metadata.missing_values[column] ? data.metadata.missing_values[column] : 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${column}</td>
                        <td>${dtype}</td>
                        <td>${missing}</td>
                    `;
                    columnTypesTable.appendChild(row);
                });
            } else {
                columnTypesTable.innerHTML = '<tr><td colspan="3">No column information available</td></tr>';
            }
            
            // Populate numeric summary
            const numericSummary = document.getElementById('numericSummary');
            if (data.metadata && data.metadata.numeric_summary && Object.keys(data.metadata.numeric_summary).length > 0) {
                // Get all statistics
                const stats = Object.keys(Object.values(data.metadata.numeric_summary)[0]);
                
                // Create table with scrollable container
                let tableHTML = '<div class="table-responsive" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">';
                tableHTML += '<table class="table table-sm table-striped">';
                
                // Header row with sticky positioning
                tableHTML += '<thead><tr><th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">Statistic</th>';
                Object.keys(data.metadata.numeric_summary).forEach(column => {
                    tableHTML += `<th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">${column}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
                // Data rows
                stats.forEach(stat => {
                    tableHTML += `<tr><td>${stat}</td>`;
                    Object.keys(data.metadata.numeric_summary).forEach(column => {
                        const value = data.metadata.numeric_summary[column][stat];
                        tableHTML += `<td>${formatNumber(value)}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody></table></div>';
                numericSummary.innerHTML = tableHTML;
            } else {
                numericSummary.innerHTML = '<p>No numeric columns found in this dataset.</p>';
            }
            
        } catch (error) {
            toggleSpinner('loadingSpinner', false);
            console.error('Error loading dataset information:', error);
            document.getElementById('errorMessage').textContent = `Error loading dataset: ${error.message}`;
            document.getElementById('errorMessage').classList.remove('d-none');
        }
    }
    
    // Load EDA
    async function loadEDA() {
        const correlationMatrix = document.getElementById('correlationMatrix');
        const distributionPlots = document.getElementById('distributionPlots');
        const featureRelationships = document.getElementById('featureRelationships');
        const missingValues = document.getElementById('missingValues');
        const outlierDetection = document.getElementById('outlierDetection');
        const spinner = document.getElementById('edaSpinner');
        
        // Check if already loaded
        if (correlationMatrix.innerHTML !== '' && distributionPlots.innerHTML !== '' && featureRelationships.innerHTML !== '' && missingValues.innerHTML !== '' && outlierDetection.innerHTML !== '') return;
        
        try {
            spinner.style.display = 'block';
            
            // Use fetch directly with error handling
            const response = await fetch(getApiUrl('/eda'));
            if (!response.ok) {
                throw new Error(`Failed to load EDA: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // Check if data is valid before proceeding
            if (!data) {
                throw new Error("No data returned from the server");
            }
            
            // Populate EDA content
            if (data.correlation && Object.keys(data.correlation).length > 0) {
                const columns = Object.keys(data.correlation);
                
                // Create table with improved styling
                let tableHTML = '<div class="table-responsive"><table class="table table-sm table-bordered correlation-table" style="border-collapse: collapse; width: 100%;">';
                
                // Header row with improved styling
                tableHTML += '<thead class="thead-light"><tr><th style="background-color: #f8f9fa; position: sticky; top: 0; z-index: 1;"></th>';
                columns.forEach(column => {
                    tableHTML += `<th style="background-color: #f8f9fa; position: sticky; top: 0; z-index: 1; text-align: center; font-weight: bold; padding: 8px;">${column}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
                // Data rows with enhanced visualization
                columns.forEach(row => {
                    tableHTML += `<tr><td style="background-color: #f8f9fa; font-weight: bold; position: sticky; left: 0; z-index: 1; padding: 8px;">${row}</td>`;
                    columns.forEach(col => {
                        const value = data.correlation[row][col];
                        
                        // Enhanced color gradient using a professional color scheme
                        let backgroundColor;
                        if (value > 0) {
                            // Blue gradient for positive correlations (more professional shade)
                            const intensity = Math.abs(value);
                            backgroundColor = `rgba(65, 105, 225, ${intensity})`;
                        } else if (value < 0) {
                            // Red gradient for negative correlations (more professional shade)
                            const intensity = Math.abs(value);
                            backgroundColor = `rgba(220, 20, 60, ${intensity})`;
                        } else {
                            // Light gray for zero correlation
                            backgroundColor = 'rgba(240, 240, 240, 1)';
                        }
                        
                        // Improved text color logic for better readability
                        const textColor = Math.abs(value) > 0.4 ? 'white' : 'black';
                        
                        // Format the value with consistent decimal places
                        const formattedValue = value.toFixed(2);
                        
                        // Add cell with enhanced styling
                        tableHTML += `<td style="background-color: ${backgroundColor}; color: ${textColor}; text-align: center; 
                                      font-weight: ${Math.abs(value) > 0.7 ? 'bold' : 'normal'}; 
                                      padding: 10px; width: ${100/columns.length}%;">${formattedValue}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody></table></div>';
                
                // Add an enhanced professional color legend
                tableHTML += `
                <div class="mt-4 mb-4">
                    <h6 class="font-weight-bold">Correlation Strength Legend</h6>
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="display: flex; width: 100%; max-width: 500px; height: 25px; border-radius: 4px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="flex-grow: 1; background: linear-gradient(to right, rgba(220,20,60,1), rgba(220,20,60,0.1), rgba(240,240,240,1))"></div>
                            <div style="flex-grow: 1; background: linear-gradient(to right, rgba(240,240,240,1), rgba(65,105,225,0.1), rgba(65,105,225,1))"></div>
                        </div>
                    </div>
                    <div style="display: flex; width: 100%; max-width: 500px; justify-content: space-between; margin-top: -10px;">
                        <span class="badge badge-danger">Strong Negative (-1.0)</span>
                        <span class="badge badge-light">No Correlation (0.0)</span>
                        <span class="badge badge-primary">Strong Positive (+1.0)</span>
                    </div>
                    <p class="small text-muted mt-2">
                        <i class="fas fa-info-circle"></i> 
                        <strong>How to interpret:</strong> Values close to +1.0 indicate strong positive correlation (variables increase together), 
                        while values close to -1.0 indicate strong negative correlation (one variable increases as the other decreases). 
                        Values near zero suggest little to no linear relationship.
                    </p>
                </div>
                `;
                
                correlationMatrix.innerHTML = tableHTML;
                
                // Add highlighting for strongest correlations
                const strongCorrelations = [];
                console.log("Checking correlations in dataset:", datasetId);
                console.log("Correlation data:", data.correlation);
                
                // Lower threshold to 0.1 to ensure we catch more correlations
                const correlationThreshold = 0.1;
                
                columns.forEach(row => {
                    columns.forEach(col => {
                        if (row !== col) {
                            const value = data.correlation[row][col];
                            console.log(`Correlation between ${row} and ${col}: ${value}`);
                            if (Math.abs(value) > correlationThreshold) {
                                strongCorrelations.push({row, col, value});
                            }
                        }
                    });
                });
                
                console.log("Strong correlations found:", strongCorrelations.length);
                
                // Sort by absolute correlation strength
                strongCorrelations.sort((a, b) => Math.abs(b.value) - Math.abs(a.value));
                
                // Display top correlations - always show this section even if no strong correlations
                let topCorrelationsHTML = `
                <div class="card mt-3 mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-star"></i> Notable Correlations</h6>
                    </div>
                    <div class="card-body">
                `;
                
                if (strongCorrelations.length > 0) {
                    topCorrelationsHTML += `
                        <p class="card-text small">The following pairs of features show notable correlations (|correlation| > ${correlationThreshold}):</p>
                        <ul class="list-group list-group-flush">
                    `;
                    
                    // Show top 10 strongest correlations instead of just 5
                    strongCorrelations.slice(0, 10).forEach(corr => {
                        const correlationType = corr.value > 0 ? 
                            '<span class="badge badge-primary">Positive</span>' : 
                            '<span class="badge badge-danger">Negative</span>';
                        
                        topCorrelationsHTML += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><strong>${corr.row}</strong> and <strong>${corr.col}</strong></span>
                                <span>${correlationType} ${Math.abs(corr.value).toFixed(2)}</span>
                            </li>
                        `;
                    });
                    
                    topCorrelationsHTML += `</ul>`;
                } else {
                    topCorrelationsHTML += `
                        <p class="card-text">No notable correlations found between variables (threshold: |correlation| > ${correlationThreshold}).</p>
                        <p class="card-text small">This suggests that the variables in this dataset may be relatively independent of each other.</p>
                    `;
                }
                
                topCorrelationsHTML += `
                    </div>
                </div>
                `;
                
                correlationMatrix.innerHTML += topCorrelationsHTML;
            } else {
                if (data.message) {
                    correlationMatrix.innerHTML = `<div class="alert alert-info">${data.message}</div>`;
                    
                    // Show column types if available
                    if (data.columns && data.dtypes) {
                        let columnInfo = '<div class="mt-3"><h5>Dataset Columns:</h5><ul class="list-group">';
                        data.columns.forEach(col => {
                            columnInfo += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                            ${col} <span class="badge badge-secondary">${data.dtypes[col]}</span></li>`;
                        });
                        columnInfo += '</ul></div>';
                        correlationMatrix.innerHTML += columnInfo;
                    }
                } else {
                    correlationMatrix.innerHTML = '<div class="alert alert-info">No numeric columns found to calculate correlation.</div>';
                }
            }
            
            // Render distribution plots using Plotly
            if (data.numeric_analysis && Object.keys(data.numeric_analysis).length > 0) {
                distributionPlots.innerHTML = '';
                
                Object.keys(data.numeric_analysis).forEach(column => {
                    const plotId = `dist-plot-${column.replace(/\s+/g, '-')}`;
                    distributionPlots.innerHTML += `
                        <div class="card mb-3">
                            <div class="card-header">${column} Distribution</div>
                            <div class="card-body">
                                <div id="${plotId}" style="height: 300px;"></div>
                            </div>
                        </div>
                    `;
                    
                    // Create histogram using Plotly
                    setTimeout(() => {
                        if (data.numeric_analysis[column].histogram) {
                            const histData = [{
                                x: data.numeric_analysis[column].histogram.x,
                                type: 'histogram',
                                name: column
                            }];
                            
                            const layout = {
                                title: `Distribution of ${column}`,
                                xaxis: { title: column },
                                yaxis: { title: 'Count' },
                                margin: { l: 50, r: 50, b: 50, t: 50, pad: 4 }
                            };
                            
                            Plotly.newPlot(plotId, histData, layout);
                        }
                    }, 100);
                });
            } else {
                distributionPlots.innerHTML = '<div class="alert alert-info">No numeric columns available for distribution plots.</div>';
            }
            
            // Render boxplots for numeric columns
            if (data.numeric_analysis && Object.keys(data.numeric_analysis).length > 0) {
                featureRelationships.innerHTML = '';
                
                Object.keys(data.numeric_analysis).forEach(column => {
                    const plotId = `box-plot-${column.replace(/\s+/g, '-')}`;
                    featureRelationships.innerHTML += `
                        <div class="card mb-3">
                            <div class="card-header">${column} Box Plot</div>
                            <div class="card-body">
                                <div id="${plotId}" style="height: 300px;"></div>
                            </div>
                        </div>
                    `;
                    
                    // Create box plot using Plotly
                    setTimeout(() => {
                        if (data.numeric_analysis[column].boxplot) {
                            const boxData = [{
                                y: data.numeric_analysis[column].boxplot.y,
                                type: 'box',
                                name: column
                            }];
                            
                            const layout = {
                                title: `Box Plot of ${column}`,
                                yaxis: { title: column },
                                margin: { l: 50, r: 50, b: 50, t: 50, pad: 4 }
                            };
                            
                            Plotly.newPlot(plotId, boxData, layout);
                        }
                    }, 100);
                });
            } else {
                featureRelationships.innerHTML = '<div class="alert alert-info">No numeric columns available for box plots.</div>';
            }
            
            // Render pie charts for categorical columns
            if (data.categorical_analysis && Object.keys(data.categorical_analysis).length > 0) {
                missingValues.innerHTML = '<h5>Categorical Data Analysis</h5>';
                
                Object.keys(data.categorical_analysis).forEach(column => {
                    // Skip if the column data is undefined or doesn't have top_values
                    if (!data.categorical_analysis[column] || !data.categorical_analysis[column].top_values) {
                        return;
                    }
                    
                    const plotId = `pie-chart-${column.replace(/\s+/g, '-')}`;
                    missingValues.innerHTML += `
                        <div class="card mb-3">
                            <div class="card-header">${column} Value Distribution</div>
                            <div class="card-body">
                                <div id="${plotId}" style="height: 300px;"></div>
                            </div>
                        </div>
                    `;
                    
                    // Create pie chart using Plotly
                    setTimeout(() => {
                        if (data.categorical_analysis[column].top_values) {
                            const pieData = [{
                                labels: data.categorical_analysis[column].top_values.labels,
                                values: data.categorical_analysis[column].top_values.values,
                                type: 'pie',
                                name: column
                            }];
                            
                            const layout = {
                                title: `Distribution of ${column}`,
                                margin: { l: 50, r: 50, b: 50, t: 50, pad: 4 }
                            };
                            
                            Plotly.newPlot(plotId, pieData, layout);
                        }
                    }, 100);
                });
            } else {
                missingValues.innerHTML = '<div class="alert alert-info">No categorical columns available for analysis.</div>';
            }
            
            // Display missing values summary
            if (data.missing_values && Object.keys(data.missing_values).length > 0) {
                outlierDetection.innerHTML = '<h5>Missing Values Summary</h5>';
                
                // Create a bar chart of missing values
                const plotId = 'missing-values-chart';
                outlierDetection.innerHTML += `
                    <div class="card mb-3">
                        <div class="card-header">Missing Values by Column</div>
                        <div class="card-body">
                            <div id="${plotId}" style="height: 400px;"></div>
                        </div>
                    </div>
                `;
                
                // Create bar chart using Plotly
                setTimeout(() => {
                    const columns = Object.keys(data.missing_values);
                    const values = columns.map(col => data.missing_values[col]);
                    
                    const barData = [{
                        x: columns,
                        y: values,
                        type: 'bar',
                        name: 'Missing Values'
                    }];
                    
                    const layout = {
                        title: 'Missing Values by Column',
                        xaxis: { title: 'Column' },
                        yaxis: { title: 'Count' },
                        margin: { l: 50, r: 50, b: 100, t: 50, pad: 4 }
                    };
                    
                    Plotly.newPlot(plotId, barData, layout);
                }, 100);
            } else {
                outlierDetection.innerHTML = '<div class="alert alert-info">No missing values found in the dataset.</div>';
            }
        } catch (error) {
            console.error('Error loading EDA:', error);
            correlationMatrix.innerHTML = `<div class="alert alert-danger">Failed to load EDA: ${error.message}</div>`;
        } finally {
            spinner.style.display = 'none';
        }
    }
    
    // Load feature engineering suggestions
    async function loadFeatureSuggestions() {
        const suggestionsList = document.getElementById('suggestionsList');
        const spinner = document.getElementById('suggestionsSpinner');
        const errorElement = document.getElementById('suggestionsError');
        
        // Check if already loaded
        if (suggestionsList.innerHTML !== '' && suggestionsList.style.display !== 'none') return;
        
        try {
            // Reset UI
            suggestionsList.style.display = 'none';
            errorElement.style.display = 'none';
            spinner.style.display = 'block';
            
            // Use fetch directly with error handling
            const response = await fetch(getApiUrl('/suggestions'));
            if (!response.ok) {
                throw new Error(`Failed to load suggestions: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data && data.feature_engineering && data.feature_engineering.length > 0) {
                // Create suggestions list
                let suggestionsHTML = '<form id="suggestionsForm">';
                
                // Add "Select All" checkbox
                suggestionsHTML += `
                    <div class="form-check mb-4">
                        <input type="checkbox" class="form-check-input" id="selectAllSuggestions">
                        <label class="form-check-label fw-bold" for="selectAllSuggestions">
                            Select All Suggestions
                        </label>
                    </div>
                    <hr>
                `;
                
                data.feature_engineering.forEach((suggestion, index) => {
                    suggestionsHTML += `
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input suggestion-checkbox" id="suggestion${index}" value="${index}">
                            <label class="form-check-label" for="suggestion${index}">
                                <strong>${suggestion.transformation}</strong> on ${suggestion.column || 'multiple columns'}: ${suggestion.reason}
                            </label>
                        </div>
                    `;
                });
                
                suggestionsHTML += '</form>';
                suggestionsList.innerHTML = suggestionsHTML;
                
                // Add event listeners to checkboxes
                document.querySelectorAll('.suggestion-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateApplyButton);
                });
                
                // Add event listener to "Select All" checkbox
                const selectAllCheckbox = document.getElementById('selectAllSuggestions');
                selectAllCheckbox.addEventListener('change', function() {
                    const isChecked = this.checked;
                    document.querySelectorAll('.suggestion-checkbox').forEach(checkbox => {
                        checkbox.checked = isChecked;
                    });
                    updateApplyButton();
                });
                
                // Show suggestions
                suggestionsList.style.display = 'block';
                
                // Update apply button state
                updateApplyButton();
            } else {
                errorElement.textContent = 'No feature engineering suggestions available for this dataset.';
                errorElement.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading feature engineering suggestions:', error);
            errorElement.textContent = `Failed to load feature engineering suggestions: ${error.message}`;
            errorElement.style.display = 'block';
        } finally {
            spinner.style.display = 'none';
        }
    }
    
    // Update apply button state
    function updateApplyButton() {
        const checkboxes = document.querySelectorAll('.suggestion-checkbox:checked');
        const applyButton = document.getElementById('applyFeaturesBtn');
        
        applyButton.disabled = checkboxes.length === 0;
    }
    
    // Update applyFeatureSuggestions function to handle the background task response correctly
    async function applyFeatureSuggestions() {
        const applyButton = document.getElementById('applyFeaturesBtn');
        const spinner = document.getElementById('applySpinner');
        const successElement = document.getElementById('applySuccess');
        const errorElement = document.getElementById('applyError');
        
        try {
            // Reset UI
            successElement.style.display = 'none';
            errorElement.style.display = 'none';
            spinner.style.display = 'block';
            applyButton.disabled = true;
            
            // Get selected suggestions
            const selectedSuggestions = Array.from(document.querySelectorAll('.suggestion-checkbox:checked'))
                .map(checkbox => parseInt(checkbox.value));
            
            if (selectedSuggestions.length === 0) {
                errorElement.textContent = 'Please select at least one suggestion to apply.';
                errorElement.style.display = 'block';
                return;
            }
            
            // Prepare request data
            const requestData = {
                suggestion_indices: selectedSuggestions,
                include_pca: false,
                pca_components: 0
            };
            
            console.log("Sending apply-features request:", requestData);
            
            // Use fetch directly with error handling
            const response = await fetch(getApiUrl('/apply-features'), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Failed to apply feature engineering: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log("Apply features response:", data);
            
            // Check if this is a background task
            if (data.status === "processing" && data.task_id) {
                // Show processing message
                successElement.innerHTML = `
                    Feature engineering started in the background. Please wait...
                `;
                successElement.style.display = 'block';
                
                // Poll for task completion
                await pollTaskStatus(data.task_id, successElement, errorElement);
            } else if (data.id) {
                // Direct response with new dataset ID
                successElement.innerHTML = `
                    Transformations applied successfully! 
                    <a href="/analysis/${data.id}" id="viewTransformedBtn">View transformed dataset</a>
                `;
                successElement.style.display = 'block';
                
                // Update the current dataset ID to the new transformed dataset
                datasetId = data.id;
            } else {
                throw new Error("Invalid response format from server");
            }
            
            // Clear EDA content to force refresh when user switches to EDA tab
            document.getElementById('correlationMatrix').innerHTML = '';
            document.getElementById('distributionPlots').innerHTML = '';
            document.getElementById('featureRelationships').innerHTML = '';
            document.getElementById('missingValues').innerHTML = '';
            document.getElementById('outlierDetection').innerHTML = '';
            
            // If we're already on the EDA tab, reload it
            if (document.getElementById('eda-tab').classList.contains('active')) {
                loadEDA();
            }
            
        } catch (error) {
            console.error('Error applying feature engineering:', error);
            errorElement.textContent = error.message || 'Failed to apply feature engineering. Please try again.';
            errorElement.style.display = 'block';
        } finally {
            spinner.style.display = 'none';
            applyButton.disabled = false;
        }
    }

    // Function to poll task status
    async function pollTaskStatus(taskId, successElement, errorElement) {
        const maxAttempts = 30; // Maximum number of polling attempts
        const pollInterval = 2000; // Poll every 2 seconds
        const spinner = document.getElementById('applySpinner');
        const loadingText = spinner.querySelector('.loading-text');
        
        for (let attempt = 0; attempt < maxAttempts; attempt++) {
            try {
                // Wait for the polling interval
                await new Promise(resolve => setTimeout(resolve, pollInterval));
                
                // Update loading text with progress
                const progress = Math.round((attempt + 1) / maxAttempts * 100);
                loadingText.innerHTML = `Applying transformations... (${progress}%)`;
                
                // Check task status
                const response = await fetch(`/api/v1/task/${taskId}`);
                if (!response.ok) {
                    throw new Error(`Failed to check task status: ${response.status} ${response.statusText}`);
                }
                
                const taskData = await response.json();
                console.log("Task status:", taskData);
                
                // Check if task is completed
                if (taskData.status === "completed" && taskData.result && taskData.result.dataset_id) {
                    // Update the current dataset ID to the new transformed dataset
                    datasetId = taskData.result.dataset_id;
                    
                    successElement.innerHTML = `
                        <div class="alert-heading h5"><i class="fas fa-check-circle"></i> Success!</div>
                        <p>Transformations applied successfully!</p>
                        <a href="/analysis/${taskData.result.dataset_id}" class="btn btn-success btn-sm" id="viewTransformedBtn">
                            <i class="fas fa-chart-bar"></i> View transformed dataset
                        </a>
                    `;
                    
                    // Clear EDA content to force refresh
                    document.getElementById('correlationMatrix').innerHTML = '';
                    document.getElementById('distributionPlots').innerHTML = '';
                    document.getElementById('featureRelationships').innerHTML = '';
                    document.getElementById('missingValues').innerHTML = '';
                    document.getElementById('outlierDetection').innerHTML = '';
                    
                    // If we're already on the EDA tab, reload it
                    if (document.getElementById('eda-tab').classList.contains('active')) {
                        loadEDA();
                    }
                    
                    return;
                }
                
                // Check if task failed
                if (taskData.status === "failed") {
                    throw new Error(taskData.error || "Feature engineering failed");
                }
                
                // If we're still processing but the task is not found in the database,
                // check the datasets list to see if a new dataset was created
                if (taskData.status === "processing" && taskData.message && taskData.message.includes("not found")) {
                    // Try to get the latest datasets
                    const datasetsResponse = await fetch('/api/v1/datasets/');
                    if (datasetsResponse.ok) {
                        const datasets = await datasetsResponse.json();
                        
                        // Sort datasets by upload time (newest first)
                        datasets.sort((a, b) => new Date(b.upload_time) - new Date(a.upload_time));
                        
                        // If we have a new dataset, assume it's the one we just created
                        if (datasets.length > 0) {
                            const latestDataset = datasets[0];
                            // Update the current dataset ID to the new transformed dataset
                            datasetId = latestDataset._id;
                            
                            successElement.innerHTML = `
                                <div class="alert-heading h5"><i class="fas fa-check-circle"></i> Success!</div>
                                <p>Transformations may have completed.</p>
                                <div class="d-flex gap-2">
                                    <a href="/analysis/${latestDataset._id}" class="btn btn-success btn-sm" id="viewTransformedBtn">
                                        <i class="fas fa-chart-bar"></i> View latest dataset
                                    </a>
                                    <a href="/" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-list"></i> View all datasets
                                    </a>
                                </div>
                            `;
                            
                            // Clear EDA content to force refresh
                            document.getElementById('correlationMatrix').innerHTML = '';
                            document.getElementById('distributionPlots').innerHTML = '';
                            document.getElementById('featureRelationships').innerHTML = '';
                            document.getElementById('missingValues').innerHTML = '';
                            document.getElementById('outlierDetection').innerHTML = '';
                            
                            // If we're already on the EDA tab, reload it
                            if (document.getElementById('eda-tab').classList.contains('active')) {
                                loadEDA();
                            }
                            
                            return;
                        }
                    }
                }
                
                // Update progress message in success element
                successElement.innerHTML = `
                    <div class="d-flex align-items-center">
                        <strong>Feature engineering in progress...</strong>
                        <div class="progress ms-auto" style="width: 60%;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: ${progress}%;" 
                                 aria-valuenow="${progress}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                ${progress}%
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error("Error polling task status:", error);
                errorElement.textContent = error.message || "Error checking task status";
                errorElement.style.display = 'block';
                return;
            }
        }
        
        // If we reach here, polling timed out
        // Try one last time to get the latest datasets
        try {
            const datasetsResponse = await fetch('/api/v1/datasets/');
            if (datasetsResponse.ok) {
                const datasets = await datasetsResponse.json();
                
                // Sort datasets by upload time (newest first)
                datasets.sort((a, b) => new Date(b.upload_time) - new Date(a.upload_time));
                
                // If we have a new dataset, assume it's the one we just created
                if (datasets.length > 0) {
                    const latestDataset = datasets[0];
                    // Update the current dataset ID to the new transformed dataset
                    datasetId = latestDataset._id;
                    
                    successElement.innerHTML = `
                        <div class="alert-heading h5"><i class="fas fa-info-circle"></i> Information</div>
                        <p>Feature engineering is taking longer than expected.</p>
                        <div class="d-flex gap-2">
                            <a href="/analysis/${latestDataset._id}" class="btn btn-success btn-sm" id="viewTransformedBtn">
                                <i class="fas fa-chart-bar"></i> View latest dataset
                            </a>
                            <a href="/" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-list"></i> View all datasets
                            </a>
                        </div>
                    `;
                    
                    // Clear EDA content to force refresh
                    document.getElementById('correlationMatrix').innerHTML = '';
                    document.getElementById('distributionPlots').innerHTML = '';
                    document.getElementById('featureRelationships').innerHTML = '';
                    document.getElementById('missingValues').innerHTML = '';
                    document.getElementById('outlierDetection').innerHTML = '';
                    
                    // If we're already on the EDA tab, reload it
                    if (document.getElementById('eda-tab').classList.contains('active')) {
                        loadEDA();
                    }
                    
                    return;
                }
            }
        } catch (e) {
            console.error("Error getting datasets list:", e);
        }
        
        // If all else fails, show a message to check the datasets list
        errorElement.textContent = "Feature engineering is taking longer than expected. Please check the datasets list later.";
        errorElement.style.display = 'block';
        
        // Add a link to the datasets list
        successElement.innerHTML = `
            <a href="/" class="btn btn-primary">View All Datasets</a>
        `;
        successElement.style.display = 'block';
    }

    // Function to apply PCA
    async function applyPCA() {
        const applyButton = document.getElementById('applyPCABtn');
        const spinner = document.getElementById('pcaSpinner');
        const successElement = document.getElementById('pcaSuccess');
        const errorElement = document.getElementById('pcaError');
        const resultsElement = document.getElementById('pcaResults');
        
        try {
            // Reset UI
            successElement.style.display = 'none';
            errorElement.style.display = 'none';
            spinner.style.display = 'block';
            applyButton.disabled = true;
            
            // Get PCA parameters
            const pcaComponents = parseInt(document.getElementById('pcaComponents').value);
            const varianceThreshold = parseFloat(document.getElementById('varianceThreshold').value);
            
            // Prepare request
            const response = await fetch(getApiUrl(`/pca?n_components=${pcaComponents}&variance_threshold=${varianceThreshold}`), {
                method: 'POST'
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Failed to apply PCA: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log("PCA response:", data);
            
            // Show success message
            successElement.innerHTML = `
                PCA applied successfully! 
                <a href="/analysis/${data.id}" id="viewPCABtn">View transformed dataset</a>
            `;
            successElement.style.display = 'block';
            
            // Display PCA results
            let resultsHTML = `
                <h5>PCA Results</h5>
                <p>Total variance explained: ${data.total_variance_explained.toFixed(2)}%</p>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th>Explained Variance (%)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.explained_variance.forEach((variance, index) => {
                resultsHTML += `
                    <tr>
                        <td>${data.components[index]}</td>
                        <td>${variance.toFixed(2)}%</td>
                    </tr>
                `;
            });
            
            resultsHTML += `
                        </tbody>
                    </table>
                </div>
                
                <h5 class="mt-3">Feature Importance</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Feature</th>
            `;
            
            data.components.forEach(component => {
                resultsHTML += `<th>${component}</th>`;
            });
            
            resultsHTML += `
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.keys(data.feature_importance).forEach(feature => {
                resultsHTML += `<tr><td>${feature}</td>`;
                data.feature_importance[feature].forEach(importance => {
                    resultsHTML += `<td>${importance.toFixed(4)}</td>`;
                });
                resultsHTML += `</tr>`;
            });
            
            resultsHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            resultsElement.innerHTML = resultsHTML;
            
            // Clear EDA content to force refresh when user switches to EDA tab
            document.getElementById('correlationMatrix').innerHTML = '';
            document.getElementById('distributionPlots').innerHTML = '';
            document.getElementById('featureRelationships').innerHTML = '';
            document.getElementById('missingValues').innerHTML = '';
            document.getElementById('outlierDetection').innerHTML = '';
            
            // If we're already on the EDA tab, reload it
            if (document.getElementById('eda-tab').classList.contains('active')) {
                loadEDA();
            }
            
        } catch (error) {
            console.error('Error applying PCA:', error);
            errorElement.textContent = error.message || 'Failed to apply PCA. Please try again.';
            errorElement.style.display = 'block';
        } finally {
            spinner.style.display = 'none';
            applyButton.disabled = false;
        }
    }

    // Initialize the new features
    document.addEventListener('DOMContentLoaded', function() {
        // Set up event listeners for the new features
        
        // Advanced Analytics tab
        document.getElementById('anomalyThreshold').addEventListener('input', function() {
            document.getElementById('anomalyThresholdValue').textContent = this.value;
        });
        
        document.getElementById('correlationThreshold').addEventListener('input', function() {
            document.getElementById('correlationThresholdValue').textContent = this.value;
        });
        
        document.getElementById('detectAnomaliesBtn').addEventListener('click', detectAnomalies);
        document.getElementById('explainCorrelationsBtn').addEventListener('click', explainCorrelations);
        document.getElementById('analyzeCausalBtn').addEventListener('click', analyzeCausality);
        
        // Collaboration tab
        document.getElementById('shareBtn').addEventListener('click', shareProject);
        document.getElementById('createVersionBtn').addEventListener('click', createVersionCheckpoint);
        document.getElementById('addCommentBtn').addEventListener('click', addComment);
        document.getElementById('addAnnotationBtn').addEventListener('click', addAnnotation);
        
        // Action buttons
        document.getElementById('shareProjectBtn').addEventListener('click', function() {
            document.getElementById('collaboration-tab').click();
        });
        
        document.getElementById('versionHistoryBtn').addEventListener('click', function() {
            document.getElementById('collaboration-tab').click();
            showVersionHistory();
        });
        
        document.getElementById('anomalyDetectionBtn').addEventListener('click', function() {
            document.getElementById('advanced-tab').click();
            document.getElementById('detectAnomaliesBtn').click();
        });
        
        document.getElementById('causalAnalysisBtn').addEventListener('click', function() {
            document.getElementById('advanced-tab').click();
            populateCausalTargets();
        });
        
        document.getElementById('helpGuideBtn').addEventListener('click', showGuidedWorkflow);
        
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Populate causal target dropdown when advanced tab is shown
        document.getElementById('advanced-tab').addEventListener('shown.bs.tab', function() {
            populateCausalTargets();
        });
    });
    
    // Advanced Analytics Functions
    async function detectAnomalies() {
        try {
            const method = document.getElementById('anomalyMethod').value;
            const threshold = document.getElementById('anomalyThreshold').value;
            
            // Show loading state
            document.getElementById('detectAnomaliesBtn').disabled = true;
            document.getElementById('detectAnomaliesBtn').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Detecting...';
            
            // Clear previous results
            document.getElementById('anomalyResults').style.display = 'none';
            
            console.log(`Detecting anomalies with method: ${method}, threshold: ${threshold}, dataset: ${datasetId}`);
            
            // Make API call with correct URL prefix
            const response = await fetch(getApiUrl(`/anomalies?method=${method}&threshold=${threshold}`, false), {
                method: 'GET'
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error("Anomaly detection error response:", errorText);
                throw new Error(`Failed to detect anomalies: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log("Anomaly detection response:", data);
            
            // Display results
            const anomalyPlot = document.getElementById('anomalyPlot');
            const anomalySummary = document.getElementById('anomalySummary');
            
            // Create a summary of the anomalies
            anomalySummary.innerHTML = `
                <h5>Anomaly Detection Summary</h5>
                <p><strong>Method:</strong> ${data.method}</p>
                <p><strong>Threshold:</strong> ${data.threshold}</p>
                <p><strong>Total rows:</strong> ${data.total_rows}</p>
                <p><strong>Anomalies detected:</strong> ${data.anomaly_count} (${data.anomaly_percentage.toFixed(2)}%)</p>
            `;
            
            // Display anomalous rows in a table
            if (data.anomalous_rows && data.anomalous_rows.length > 0) {
                const columns = Object.keys(data.anomalous_rows[0]);
                
                let tableHTML = `
                    <h5 class="mt-4">Anomalous Data Points</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    ${columns.map(col => `<th>${col}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Add rows
                data.anomalous_rows.forEach(row => {
                    tableHTML += '<tr>';
                    columns.forEach(col => {
                        tableHTML += `<td>${row[col]}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                anomalyPlot.innerHTML = tableHTML;
            } else {
                anomalyPlot.innerHTML = `<div class="alert alert-info">No anomalies detected with the current settings.</div>`;
            }
            
            // Show the results
            document.getElementById('anomalyResults').style.display = 'block';
            
        } catch (error) {
            console.error('Error detecting anomalies:', error);
            // Show error message
            const anomalyResults = document.getElementById('anomalyResults');
            anomalyResults.style.display = 'block';
            anomalyResults.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error:</strong> ${error.message || 'Failed to detect anomalies'}
                </div>
            `;
        } finally {
            // Reset button
            document.getElementById('detectAnomaliesBtn').disabled = false;
            document.getElementById('detectAnomaliesBtn').innerHTML = 'Detect Anomalies';
        }
    }
    
    async function explainCorrelations() {
        try {
            const method = document.getElementById('correlationMethod').value;
            const threshold = document.getElementById('correlationThreshold').value;
            
            // Show loading state
            document.getElementById('explainCorrelationsBtn').disabled = true;
            document.getElementById('explainCorrelationsBtn').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analyzing...';
            
            // Clear previous results
            document.getElementById('correlationResults').style.display = 'none';
            
            console.log(`Explaining correlations with method: ${method}, threshold: ${threshold}, dataset: ${datasetId}`);
            
            // Make API call with correct URL prefix
            const response = await fetch(getApiUrl(`/correlation-explanation?method=${method}&threshold=${threshold}`, false), {
                method: 'GET'
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error("Correlation explanation error response:", errorText);
                throw new Error(`Failed to explain correlations: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log("Correlation explanation response:", data);
            
            // Display results
            const correlationExplanations = document.getElementById('correlationExplanations');
            const correlationNetwork = document.getElementById('correlationNetwork');
            
            // Display correlation explanations
            if (data.strong_correlations && data.strong_correlations.length > 0) {
                let explanationsHTML = `
                    <h5>Strong Correlations Explained</h5>
                    <div class="list-group">
                `;
                
                data.strong_correlations.forEach(corr => {
                    const correlationClass = corr.type === 'positive' ? 'text-success' : 'text-danger';
                    const correlationValue = corr.correlation.toFixed(3);
                    
                    explanationsHTML += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6>${corr.feature1} ↔ ${corr.feature2}</h6>
                                <span class="badge bg-primary ${correlationClass}">${correlationValue}</span>
                            </div>
                            <p class="mb-1">${corr.explanation}</p>
                            <small class="text-muted">Strength: ${corr.strength}</small>
                        </div>
                    `;
                });
                
                explanationsHTML += `</div>`;
                correlationExplanations.innerHTML = explanationsHTML;
                
                // Simple visualization of correlation network
                correlationNetwork.innerHTML = `
                    <h5 class="mt-4">Correlation Network</h5>
                    <div class="alert alert-info">
                        A network visualization would be displayed here in a production environment.
                    </div>
                `;
            } else {
                correlationExplanations.innerHTML = `
                    <div class="alert alert-info">
                        No strong correlations found with the current threshold (${threshold}).
                        Try lowering the threshold to see more correlations.
                    </div>
                `;
                correlationNetwork.innerHTML = '';
            }
            
            // Show the results
            document.getElementById('correlationResults').style.display = 'block';
            
        } catch (error) {
            console.error('Error explaining correlations:', error);
            // Show error message
            const correlationResults = document.getElementById('correlationResults');
            correlationResults.style.display = 'block';
            correlationResults.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error:</strong> ${error.message || 'Failed to explain correlations'}
                </div>
            `;
        } finally {
            // Reset button
            document.getElementById('explainCorrelationsBtn').disabled = false;
            document.getElementById('explainCorrelationsBtn').innerHTML = 'Explain Correlations';
        }
    }
    
    async function analyzeCausality() {
        try {
            const target = document.getElementById('causalTarget').value;
            const method = document.getElementById('causalMethod').value;
            
            if (!target) {
                alert('Please select a target variable');
                return;
            }
            
            // Show loading state
            document.getElementById('analyzeCausalBtn').disabled = true;
            document.getElementById('analyzeCausalBtn').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analyzing...';
            
            // Clear previous results
            document.getElementById('causalResults').style.display = 'none';
            
            console.log(`Analyzing causality for target: ${target}, method: ${method}, dataset: ${datasetId}`);
            
            // Make API call with correct URL prefix
            const response = await fetch(getApiUrl('/causal-analysis', false), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ target, method })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error("Causal analysis error response:", errorText);
                throw new Error(`Failed to analyze causality: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log("Causal analysis response:", data);
            
            // Display results
            const causalResults = document.getElementById('causalResults');
            
            if (data.potential_causes && data.potential_causes.length > 0) {
                let resultsHTML = `
                    <div class="card mb-4">
                        <div class="card-header">Causal Analysis Results for ${target}</div>
                        <div class="card-body">
                            <p><strong>Method:</strong> ${data.method}</p>
                            <p><strong>Target Variable:</strong> ${data.target}</p>
                            
                            <h5 class="mt-4">Potential Causes</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Variable</th>
                                            <th>Correlation</th>
                                            <th>Direction</th>
                                            <th>Strength</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                data.potential_causes.forEach(cause => {
                    const correlationValue = cause.correlation.toFixed(3);
                    const correlationClass = cause.direction === 'positive' ? 'text-success' : 'text-danger';
                    
                    resultsHTML += `
                        <tr>
                            <td>${cause.feature}</td>
                            <td class="${correlationClass}">${correlationValue}</td>
                            <td>${cause.direction}</td>
                            <td>${cause.strength}</td>
                        </tr>
                    `;
                });
                
                resultsHTML += `
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <strong>Note:</strong> ${data.disclaimer || "Causal relationships are inferred from observational data and should be validated with domain knowledge and controlled experiments."}
                            </div>
                        </div>
                    </div>
                `;
                
                causalResults.innerHTML = resultsHTML;
            } else {
                causalResults.innerHTML = `
                    <div class="alert alert-info">
                        No significant causal relationships found for ${target} using the ${method} method.
                    </div>
                `;
            }
            
            // Show the results
            causalResults.style.display = 'block';
            
        } catch (error) {
            console.error('Error analyzing causality:', error);
            // Show error message
            const causalResults = document.getElementById('causalResults');
            causalResults.style.display = 'block';
            causalResults.innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error:</strong> ${error.message || 'Failed to analyze causality'}
                </div>
            `;
        } finally {
            // Reset button
            document.getElementById('analyzeCausalBtn').disabled = false;
            document.getElementById('analyzeCausalBtn').innerHTML = 'Analyze Causality';
        }
    }
    
    // Function to populate causal target dropdown with numeric columns
    async function populateCausalTargets() {
        try {
            // Get dataset info to extract column names with correct URL prefix
            const response = await fetch(getApiUrl(""));
            
            if (!response.ok) {
                throw new Error(`Failed to get dataset info: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log("Dataset info for causal targets:", data);
            
            // Get the dropdown
            const targetDropdown = document.getElementById('causalTarget');
            
            // Clear existing options except the first one
            while (targetDropdown.options.length > 1) {
                targetDropdown.remove(1);
            }
            
            // Add numeric columns as options
            if (data.columns && data.metadata && data.metadata.dtypes) {
                // Filter for numeric columns based on their data types
                const numericColumns = data.columns.filter(column => {
                    const dtype = data.metadata.dtypes[column] || "";
                    return dtype.includes('int') || dtype.includes('float') || dtype.includes('number');
                });
                
                console.log("Numeric columns found:", numericColumns);
                
                numericColumns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column;
                    option.textContent = column;
                    targetDropdown.appendChild(option);
                });
                
                // If we found numeric columns, enable the analyze button
                document.getElementById('analyzeCausalBtn').disabled = numericColumns.length === 0;
                
                // Show a message if no numeric columns were found
                if (numericColumns.length === 0) {
                    console.warn("No numeric columns found for causal analysis");
                    // Add a disabled option with a message
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "No numeric columns available";
                    option.disabled = true;
                    targetDropdown.appendChild(option);
                }
            } else {
                console.error("Dataset response missing required structure:", data);
                // Add a disabled option with an error message
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Error loading columns";
                option.disabled = true;
                targetDropdown.appendChild(option);
            }
        } catch (error) {
            console.error('Error populating causal targets:', error);
            // Add a disabled option with an error message
            const targetDropdown = document.getElementById('causalTarget');
            const option = document.createElement('option');
            option.value = "";
            option.textContent = "Error: " + error.message;
            option.disabled = true;
            targetDropdown.appendChild(option);
        }
    }
    
    // Collaboration Functions
    function shareProject() {
        const email = document.getElementById('shareEmail').value;
        const permission = document.getElementById('sharePermission').value;
        
        if (!email) {
            alert('Please enter an email address');
            return;
        }
        
        // In a real implementation, this would make an API call
        // For now, we'll just update the UI
        
        const collaboratorsList = document.getElementById('collaboratorsList');
        const newCollaborator = document.createElement('div');
        newCollaborator.className = 'list-group-item';
        newCollaborator.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${email}</h6>
                <small>${permission}</small>
            </div>
            <small class="text-muted">Added just now</small>
        `;
        
        collaboratorsList.appendChild(newCollaborator);
        
        // Clear the input
        document.getElementById('shareEmail').value = '';
        
        // Show success message
        alert(`Project shared with ${email} (${permission} access)`);
    }
    
    function createVersionCheckpoint() {
        const versionName = document.getElementById('versionName').value;
        const versionNotes = document.getElementById('versionNotes').value;
        
        if (!versionName) {
            alert('Please enter a version name');
            return;
        }
        
        // In a real implementation, this would make an API call
        // For now, we'll just update the UI
        
        const versionHistoryList = document.getElementById('versionHistoryList');
        
        // Update current version to not be current
        const currentVersionItem = versionHistoryList.querySelector('.text-muted');
        if (currentVersionItem) {
            currentVersionItem.textContent = '';
        }
        
        // Add new version
        const newVersion = document.createElement('div');
        newVersion.className = 'list-group-item';
        newVersion.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${versionName}</h6>
                <small class="text-muted">Current Version</small>
            </div>
            <p class="mb-1">${versionNotes || 'No description provided'}</p>
            <small class="text-muted">Created just now</small>
        `;
        
        versionHistoryList.prepend(newVersion);
        
        // Clear the inputs
        document.getElementById('versionName').value = '';
        document.getElementById('versionNotes').value = '';
        
        // Show success message
        alert(`Version checkpoint "${versionName}" created successfully`);
    }
    
    function showVersionHistory() {
        // This would fetch the version history from the server
        // For now, we'll just switch to the collaboration tab
        document.getElementById('collaboration-tab').click();
    }
    
    function addComment() {
        const commentText = document.getElementById('newComment').value;
        
        if (!commentText) {
            alert('Please enter a comment');
            return;
        }
        
        // Add the comment to the UI
        const commentsContainer = document.getElementById('commentsContainer');
        const newComment = document.createElement('div');
        newComment.className = 'card mb-2';
        newComment.innerHTML = `
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">You, just now</h6>
                <p class="card-text">${commentText}</p>
            </div>
        `;
        
        commentsContainer.appendChild(newComment);
        
        // Clear the input
        document.getElementById('newComment').value = '';
    }
    
    function addAnnotation() {
        // In a real implementation, this would open a modal or interface to select a data point
        // For now, we'll just add a placeholder annotation
        
        const annotationsList = document.getElementById('annotationsList');
        
        // Remove the "No annotations yet" message if it exists
        const noAnnotationsMsg = annotationsList.querySelector('.text-muted');
        if (noAnnotationsMsg) {
            annotationsList.innerHTML = '';
        }
        
        // Add a new annotation
        const newAnnotation = document.createElement('div');
        newAnnotation.className = 'list-group-item';
        newAnnotation.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">Annotation on Feature X</h6>
                <small class="text-muted">Just now</small>
            </div>
            <p class="mb-1">This data point shows an interesting pattern.</p>
        `;
        
        annotationsList.appendChild(newAnnotation);
    }
    
    function showGuidedWorkflow() {
        // In a real implementation, this would show a step-by-step guide
        // For now, we'll just show an alert
        
        alert('Guided Workflow: This feature would provide step-by-step guidance for common analysis tasks.');
    }
    
    // Enhanced error handling
    window.addEventListener('error', function(event) {
        console.error('Global error caught:', event.error);
        
        // Show a user-friendly error message
        const errorMessage = document.createElement('div');
        errorMessage.className = 'alert alert-danger alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
        errorMessage.setAttribute('role', 'alert');
        errorMessage.innerHTML = `
            <strong>Error:</strong> ${event.error.message || 'An unexpected error occurred'}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        document.body.appendChild(errorMessage);
        
        // Remove the error message after 5 seconds
        setTimeout(() => {
            errorMessage.remove();
        }, 5000);
    });
    
    // Add validation for all user inputs
    function validateInput(input, validationFunction, errorMessage) {
        const value = input.value;
        const isValid = validationFunction(value);
        
        if (!isValid) {
            input.classList.add('is-invalid');
            
            // Create or update error message
            let errorElement = input.nextElementSibling;
            if (!errorElement || !errorElement.classList.contains('invalid-feedback')) {
                errorElement = document.createElement('div');
                errorElement.className = 'invalid-feedback';
                input.parentNode.insertBefore(errorElement, input.nextSibling);
            }
            
            errorElement.textContent = errorMessage;
            return false;
        } else {
            input.classList.remove('is-invalid');
            
            // Remove error message if it exists
            const errorElement = input.nextElementSibling;
            if (errorElement && errorElement.classList.contains('invalid-feedback')) {
                errorElement.remove();
            }
            
            return true;
        }
    }
</script>
{% endblock %}